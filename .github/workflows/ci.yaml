name: CI Pipeline

on:
  push:
    branches:
      - master
  pull_request:
    branches:
      - master

env:
  # Test environment variables for Docker Compose
  POSTGRES_SUPERUSER: postgres
  POSTGRES_SUPERUSER_PASSWORD: postgres
  POSTGRES_SUPERUSER_DB: postgres
  POSTGRES_BACKEND_DB_NAME: accounts_db
  POSTGRES_BACKEND_USER: accounts_user
  POSTGRES_BACKEND_PASSWORD: accounts_password
  RABBITMQ_USER: user
  RABBITMQ_PASSWORD: password
  REDIS_PASSWORD: redispassword
  GRAFANA_ADMIN_USER: user
  GRAFANA_ADMIN_PASSWORD: password
  BACKEND_URL: http://backend:8080
  RUST_LOG: info
  POSTGRES_BACKEND_URL: postgresql://accounts_user:accounts_password@postgres:5432/accounts_db
  REDIS_URL: redis://:redispassword@redis:6379
  RABBITMQ_URL: amqp://user:password@rabbitmq:5672

jobs:
  # Existing local build tests (fast feedback)
  build-test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        project: [indexer, search-core, backend, crawler] # add frontend

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Rust
        if: ${{ matrix.project == 'indexer' || matrix.project == 'search-core' }}
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: stable
          components: clippy, rustfmt

      - name: Setup Go
        if: ${{ matrix.project == 'backend' || matrix.project == 'crawler' }}
        uses: actions/setup-go@v4
        with:
          go-version: 1.21

      # - name: Setup Node.js and pnpm
      #   if: ${{ matrix.project == 'frontend' }}
      #   uses: actions/setup-node@v3
      #   with:
      #     node-version: 20
      #     cache: 'pnpm'
      # - name: Install pnpm (frontend)
      #   if: ${{ matrix.project == 'frontend' }}
      #   run: npm install -g pnpm
      #
      # - name: Install frontend dependencies
      #   if: ${{ matrix.project == 'frontend' }}
      #   run: pnpm install
      #   working-directory: ./frontend

      - name: Build Rust project
        if: ${{ matrix.project == 'indexer' || matrix.project == 'search-core' }}
        run: cargo build --release
        working-directory: ./${{ matrix.project }}

      - name: Build Go project
        if: ${{ matrix.project == 'backend' || matrix.project == 'crawler' }}
        run: go build -o app
        working-directory: ./${{ matrix.project }}

      - name: Build frontend project
        if: ${{ matrix.project == 'frontend' }}
        run: pnpm build
        working-directory: ./frontend

      - name: Test Rust project
        if: ${{ matrix.project == 'indexer' || matrix.project == 'search-core' }}
        run: cargo test
        working-directory: ./${{ matrix.project }}

      - name: Test Go project
        if: ${{ matrix.project == 'backend' || matrix.project == 'crawler' }}
        run: go test ./...
        working-directory: ./${{ matrix.project }}

      # - name: Test frontend project
      #   if: ${{ matrix.project == 'frontend' }}
      #   run: pnpm test
      #   working-directory: ./frontend

  # New Docker Compose integration tests
  docker-compose-test:
    runs-on: ubuntu-latest
    needs: build-test  # Only run if build-test passes
    timeout-minutes: 15
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Build all Docker services
        run: |
          docker compose build

      - name: Validate Docker Compose configuration
        run: |
          docker compose config

      - name: Start core dependencies
        run: |
          docker compose up -d postgres redis rabbitmq
          
      - name: Wait for dependencies to be ready
        run: |
          # Wait for PostgreSQL
          echo "Waiting for PostgreSQL..."
          timeout 60s bash -c 'until docker compose exec -T postgres pg_isready; do sleep 2; done'
          
          # Wait for Redis
          echo "Waiting for Redis..."
          timeout 30s bash -c 'until docker compose exec -T redis redis-cli -a $REDIS_PASSWORD ping | grep -q PONG; do sleep 2; done'
          
          # Wait for RabbitMQ
          echo "Waiting for RabbitMQ..."
          timeout 30s bash -c 'until docker compose exec -T rabbitmq rabbitmqctl status; do sleep 2; done'

      - name: Test service builds
        run: |
          echo "Testing application service builds..."
          for service in backend crawler indexer search-core; do
            echo "Building $service..."
            docker compose build $service
          done

      - name: Test service containers
        run: |
          echo "Testing service container startup..."
          for service in backend crawler indexer search-core; do
            echo "Testing $service container..."
            docker compose run --rm $service echo "‚úì $service container starts successfully"
          done

      - name: Test service connectivity
        run: |
          echo "Testing service connectivity..."
          
          # Test backend can connect to PostgreSQL
          echo "Testing backend to PostgreSQL..."
          docker compose run --rm backend sh -c "timeout 10s bash -c 'until nc -z postgres 5432; do sleep 2; done'" && echo "‚úì Backend can reach PostgreSQL"
          
          # Test crawler can connect to Redis and RabbitMQ
          echo "Testing crawler to Redis..."
          docker compose run --rm crawler sh -c "timeout 10s bash -c 'until nc -z redis 6379; do sleep 2; done'" && echo "‚úì Crawler can reach Redis"
          
          echo "Testing crawler to RabbitMQ..."
          docker compose run --rm crawler sh -c "timeout 10s bash -c 'until nc -z rabbitmq 5672; do sleep 2; done'" && echo "‚úì Crawler can reach RabbitMQ"

      - name: Check full stack startup
        run: |
          echo "Testing full stack startup..."
          docker compose up -d
          sleep 10
          echo "Running services:"
          docker compose ps

      - name: Cleanup
        if: always()
        run: |
          docker compose down --remove-orphans

  # Optional: Lint and security scan
  security-scan:
    runs-on: ubuntu-latest
    needs: build-test
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Run Hadolint (Dockerfile linter)
        uses: hadolint/hadolint-action@v3.1.0
        with:
          dockerfile: |
            backend/Dockerfile
            crawler/Dockerfile
            indexer/Dockerfile
            search-core/Dockerfile
            frontend/Dockerfile

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'

  # Final success notification
  success:
    runs-on: ubuntu-latest
    needs: [build-test, docker-compose-test, security-scan]
    if: always()
    steps:
      - name: CI Status
        run: |
          if [[ "${{ needs.build-test.result }}" == "success" && "${{ needs.docker-compose-test.result }}" == "success" ]]; then
            echo "üéâ All CI checks passed!"
          else
            echo "‚ùå Some CI checks failed"
            exit 1
          fi
